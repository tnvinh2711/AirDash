# Data Model: File Transfer Server (Receive Logic)

**Feature**: 005-file-transfer-server | **Date**: 2025-12-06

## Entity Overview

| Entity | Purpose | Storage | Freezed |
|--------|---------|---------|---------|
| TransferMetadata | Handshake request payload | In-memory | ✅ |
| TransferSession | Active transfer state | In-memory | ✅ |
| ServerState | Overall server status | In-memory (Riverpod) | ✅ |
| TransferProgress | Real-time progress | In-memory | ✅ |
| HandshakeResponse | Handshake endpoint response | Transient | ❌ (JSON only) |
| UploadResult | Upload endpoint response | Transient | ❌ (JSON only) |

---

## Entity Definitions

### TransferMetadata (Freezed)

Received in handshake request body. Contains all information about the incoming transfer.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| fileName | String | ✅ | Original filename (or folder name) |
| fileSize | int | ✅ | Total size in bytes |
| fileType | String | ✅ | MIME type or extension identifier |
| checksum | String | ✅ | MD5 hash of file content |
| isFolder | bool | ✅ | True if ZIP-compressed folder |
| fileCount | int | ✅ | Number of files (1 for single, >1 for folder) |
| senderDeviceId | String | ✅ | Sender's service instance name |
| senderAlias | String | ✅ | Sender's human-readable device name |

**Validation Rules**:
- `fileSize` > 0
- `fileName` non-empty, sanitized for filesystem
- `checksum` 32-char hex string (MD5)

---

### TransferSession (Freezed)

Active session state stored after successful handshake.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sessionId | String | ✅ | UUID generated by server |
| metadata | TransferMetadata | ✅ | Original handshake data |
| createdAt | DateTime | ✅ | When session was created |
| status | SessionStatus | ✅ | Current session state |

**SessionStatus Enum**:
- `pending` - Awaiting upload
- `receiving` - Upload in progress
- `completed` - Transfer successful
- `failed` - Transfer failed (with reason)
- `expired` - Timed out (5 minutes)

---

### ServerState (Freezed)

Root state object for ServerController.

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| isRunning | bool | ✅ | false | Server listening status |
| port | int? | ❌ | null | Bound port (null if stopped) |
| isBroadcasting | bool | ✅ | false | Discovery broadcast active |
| activeSession | TransferSession? | ❌ | null | Current active transfer |
| transferProgress | TransferProgress? | ❌ | null | Progress of active transfer |
| error | String? | ❌ | null | Last error message |

**State Transitions**:
```
Stopped → Starting → Running (idle) → Receiving → Completed/Failed → Running (idle)
                                                                   ↓
                                                              Stopped
```

---

### TransferProgress (Freezed)

Real-time progress information.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| bytesReceived | int | ✅ | Bytes written to disk |
| totalBytes | int | ✅ | Expected total (from metadata) |
| startedAt | DateTime | ✅ | When upload started |

**Computed Properties**:
- `percentComplete`: `(bytesReceived / totalBytes * 100).round()`
- `bytesPerSecond`: Calculated from elapsed time

---

## API Response Models (JSON)

### HandshakeResponse

Returned from `POST /api/v1/info`.

```json
{
  "accepted": true,
  "sessionId": "uuid-string",
  "serverCapabilities": {
    "maxFileSize": null,
    "supportedTypes": ["*"]
  },
  "error": null
}
```

**Rejection Reasons** (when `accepted: false`):
- `busy` - Another transfer in progress
- `insufficient_storage` - Not enough disk space
- `invalid_request` - Malformed metadata

### UploadResult

Returned from `POST /api/v1/upload`.

```json
{
  "success": true,
  "savedPath": "/path/to/received/file.pdf",
  "checksumVerified": true,
  "error": null
}
```

---

## Integration with Existing Models

### HistoryRepository Integration

On transfer completion/failure, create `NewTransferHistoryEntry`:

| TransferSession Field | → | NewTransferHistoryEntry Field |
|----------------------|---|-------------------------------|
| sessionId | → | transferId |
| metadata.fileName | → | fileName |
| metadata.fileCount | → | fileCount |
| metadata.fileSize | → | totalSize |
| metadata.fileType | → | fileType |
| status (mapped) | → | status |
| (constant) | → | direction = TransferDirection.received |
| metadata.senderAlias | → | remoteDeviceAlias |

